# VizIoT Installation

## Requirements and Notes

- This application was built and deployed with Ubuntu version 18.04
	- Recommend using Linux to deploy this application locally
- Deploying this application on a Linux machine requires administrator permissions on the machine
	- Recommend prefixing all commands with 'sudo' 
- Dependencies:
	1. NodeJS
	2. MongoDB
	3. Python 3

## MongoDB

To run the application, install MongoDB and run an instance of MongoDB on the machine running the pypcap. By default, the application searches for the instance at localhost port 27017. To reconfigure the application to search for the MongoDB instance elsewhere, edit 'viziot.conf' which is at the top level directory of vizIoT.

[MongoDB Installation Instructions](https://docs.mongodb.com/manual/installation/)

Note:: MongoDB must be running before any other part of the application in order for the application to work.

## How to install
### In production (use installation scripts)
- Set up the pypcap

	Add a file named 'devices.txt' at the top level directory of pypcap. Each line represents a device containing its MAC address and name separated by a space. For example:
	
	```
	8c:1d:96:e8:da:dc fridge
	70:2c:1f:3b:39:53 labelprinter
	...
	```
	Note:: All MAC address values must have at least 1 character, and if the value is less than 16, do not include a '0' value before that character. For example:
	
	```
	0:e:f3:3b:85:e5
	```
	
	is the proper way to format a MAC address with a 0 value or a value less than 16.
	
	Add a file named 'ips.txt' at the top level directory of pypcap. Each line represents an ip containing its address and name separated by a space. For example:
	
	```
	224.0.0.251 Multicast
	...
	```
	
- Run the following command at the top level directory of vizIoT:

	```
	python3 viziot.py p b f
	```    
	
	The above command starts the three parts of the application.
	- 'p' stands for 'pypcap'
	- 'b' stands for 'backend'
	- 'f' stands for 'frontend'
	- The sequence of 'p', 'b' and 'f' does not matter.

	You can pick which part(s) that need(s) to start. For example:
	
	```
	python3 viziot.py p // only start pypcap
	python3 viziot.py b f // start backend and frontend
	python3 viziot.py p b // start pypcap and backend
	```
	
	Then follow the lead in the terminal to set the configuration, install dependencies and start the application.

- To update the configuration, edit 'viziot.conf' which is at the top level directory of vizIoT.
- To check out which parts are running, run the following command:
	
	```
	python3 viziot.py status
	```

- To stop the application, run the following command:

	```
	python3 viziot.py stop
	```   
	
	This command stops all the parts.
	You can pick which part(s) that need(s) to stop. For example:
	
	```
	python3 viziot.py p // only stop pypcap
	python3 viziot.py b f // stop backend and frontend
	python3 viziot.py p b // stop pypcap and backend
	```
	
Note:: If the pypcap and backend run on different systems, please stop the pypcap as well if the backend is stopped, since the backend deletes old data on a regular basis in case there is too much data in the database generated by the pypcap. In other words, if the pypcap runs, please run the backend as well.

Note:: If there is an update in 'devices.txt' or 'ips.txt', please stop the application and restart the pypcap. When the terminal asks "Is this your first time running the pypcap? (y/other keys): ", input 'y' so that the database can be updated.

### In development
#### Pypcap

- To set up the pypcap, run the following commands at the top level directory of the pypcap:

	- To install scapy:

	```
	pip3 install scapy
	```

	- To install pymongo

	```
	pip3 install pymongo
	```

	Note:: These commands only need to be run once on initial installation of the pypcap; they do not need to be run more than once.

- To place devices into the MongoDB instance, navigate to the pypcap directory:

	Add a file named 'devices.txt' at the top level directory of pypcap. Each line represents a device containing its MAC address and name separated by a space. For example:
	
	```
	8c:1d:96:e8:da:dc fridge
	70:2c:1f:3b:39:53 labelprinter
	...
	```
	Note:: All MAC address values must have at least 1 character, and if the value is less than 16, do not include a '0' value before that character. For example:
	
	```
	0:e:f3:3b:85:e5
	```
	
	is the proper way to format a MAC address with a 0 value or a value less than 16.
	
	Then run the following command:
	
	```
	python3 addDevices.py
	````

	Note:: If a new device is added to the list, run this command again to see the device reflected in the application. Restart the application to reflect this change.

- To place IP address mappings into the MongoDB instance, navigate to the pypcap directory:

	Add a file named 'ips.txt' at the top level directory of pypcap. Each line represents an ip containing its address and name separated by a space. For example:
	
	```
	224.0.0.251 Multicast
	...
	```
	
	Then run the following command: 
	
	```
	python3 addIPs.py
	```

	Note:: If a new IP address mapping is added to the list, run this command again to see the device reflected in the application. Restart the application to reflect this change.
	
- Set up config.py:

	Add a file named 'config.py' at the top level directory of pypcap. For example:
	
	```
	mongo_uri="mongodb://localhost:27017/"
	database_name="scapy"
	iface="eth1"
	```
	
	Note:: To specify a specific MongoDB instance, specify the IP of the instance and then the port running the instance as follows:

	```
	mongo_uri="mongodb://<IP>:<PORT>/"
	```
	
	If authentication is required, specify the mongo_uri as follows:
	
	```
	mongo_uri="mongodb://<IP>:<PORT>@<USERNAME>:<PASSWORD>/<DATABASE_NAME>"
	```
	
	In the event this is a local MongoDB instance and MongoDB has been set up to use default values, this string should be:

	```
	mongo_uri="mongodb://localhost:27017/"
	```
	
	Note:: 'iface' is the interface over which data is captured. It is used in the sniff() function as follows:
	
	```
	sniff(iface=<IFACE>, prn=http_header, filter="tcp or udp", store=0)
	```
	
- To begin capturing data, run the following command in the pypcap directory:

	```
	python3 sniff.py
	``` 
	
- To stop the pypcap, type 'CTRL + C' in the terminal. 

#### Backend

- Set up .env:

	Add a file named '.env' at the top level directory of backend. For example:
	```
	MONGO_URI=mongodb://localhost:27017/scapy
	LOCAL_IP=localhost
	PORT=3000
	```
	
	Note:: If authentication is required, specify the mongo_uri as follows:
	Without authsource:
	
	```
	MONGO_URI=mongodb://<IP>:<PORT>@<USERNAME>:<PASSWORD>/<DATABASE_NAME>?
	```
	
	With authsource:
	
	```
	MONGO_URI=mongodb://<IP>:<PORT>@<USERNAME>:<PASSWORD>/<DATABASE_NAME>?authSource=<AUTHSOURCE>
	```
	
- Run the following command at the command line in the top level directory of backend before running the application for the first time:

	```
	yarn install
	```

	Note:: This is only required for first-time setup; this command does not need to be run more than once.

- To run the backend, run the following command:

	```
	npm start
	```

- To stop the backend, type 'CTRL + C' in the terminal.

#### Frontend

- Please make sure the ip and port in backend.env match the url in frontend/src/constants/RequestConstants.js.

- Run the following command at the command line in the top level directory of backend before running the application for the first time:

	```
	yarn install
	```

	Note:: This is only required for first-time setup; this command does not need to be run more than once.

- To run the frontend, run the following command:

	```
	npm run dev-server
	```
	
- To stop the frontend, type 'CTRL + C' in the terminal.
